<html>

    <head>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"> </script>
        
        <style>
            #mynetwork {
                width: 1000px;
                height: 800px;
                border: 1px solid lightgray;
            }
            .dropdown {
                z-index: 999;
                position: fixed;
                display: none;
                background-color: lightblue;
            }
            .dropdownItem {

                display: block;
                position: relative;
                background-color: #f9f9f9;
                min-width: 160px;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                padding: 12px 16px;
                z-index: 1;

                cursor: pointer;
            }

            .dropdownItem:hover {
                background-color: grey;
            }

        </style>
        <script>

            nodeIdByIP = {};
            edgeByFromIP = {};

            currentlyActiveNodes = [];

            function prepare(tokens) {

                return tokens.slice(1);
            }

            function sendRequest(name, data) { // here the data and url are not hardcoded anymore

                    return $.ajax({
                        type: "post",
                        url: "http://localhost:8000/",
                        data: name + "-" + data,
                        dataType: "text",
                        contentType: "charset=utf-8",
                        success: function(data) {
                            
                            console.log(data);

                            var tokens = data.split('-');

                            if(tokens[0] == "active_node_list") {

                                var ips = prepare(tokens);

                                for(var i = 0; i < ips.length; i++) {

                                    if(!nodeIdByIP.hasOwnProperty(ips[i])) {

                                        var id = Math.random();
                                        var edgeId = Math.random();

                                        var myId = nodeIdByIP["127.0.0.1"];

                                        nodes.add([{id: id, label: ips[i], first: false, shape: 'box' }]);
                                        edges.add([{id: edgeId, from: myId, to: id}]);

                                        nodeIdByIP[ips[i]] = id;
                                        edgeByFromIP[ips[i]] = edgeId;
                                    }
                                }
                            }

                            if(tokens[0] == "node_state") {

                                var states = prepare(tokens);
                                
                                var writingToo = states[0];
                                var readingFrom = states[1];

                                var myNode = nodeIdByIP["127.0.0.1"];
                                var target = nodeIdByIP[writingToo];

                                var node = nodes.get(myNode);
                                var targetNode = nodes.get(target);
                                
                               // var edge = edges.get();

                                if(writingToo != "none") {

                                    console.log("Setting node color");

                                    node.color = {
                                        background: 'green'
                                    }

                                    // targetNode.color = {
                                    //     background: 'green'
                                    // }

                                } else {
                                    console.log("Resetting node color");

                                    node.color = {
                                        background: '#97C2FC'
                                    }

                                    // targetNode.color = {
                                    //     background: '#97C2FC'
                                    // }
                                }

                                // if(readingFrom != "none") {

                                //     node.color = {
                                //         background: 'gre'
                                //     }

                                // } else {

                                //     node.color = {
                                //         background: '#97C2FC'
                                //     }
                                // }
                                nodes.update(node);
                                //nodes.update(targetNode);

                            }  

                        }.bind(this),
                        error: function(a, b, c) {

                        }
                    });
            }
            
            function ctxMenuClick(action) {

                if(action == "create_job") {

                    var codeFn = "example_dll.dll";
                    var dataFn = "data.dat";
                    var jobName = "run";

                    codeFn = window.prompt("Code filename: ");
                    dataFn = window.prompt("Data filename: ");
                    jobName = window.prompt("Job name: ");

                    if(codeFn.length > 0 && dataFn.length > 0 && jobName.length > 0) {

                        sendRequest(action, codeFn + "-" + dataFn + "-" + jobName);
                    }
                }
            }

            window.onload = function() {

                nodes = new vis.DataSet([]);
                edges = new vis.DataSet([]);

                container = document.getElementById('mynetwork');
                
                data = {
                    nodes: nodes,
                    edges: edges
                };
                options = {interaction:{hover:true}};
                network = new vis.Network(container, data, options);

                var thisNode = Math.random();

                nodes.add([{id: thisNode, label: '127.0.0.1', first: true, shape: 'square' }]);

                nodeIdByIP["127.0.0.1"] = thisNode;

                network.on("click", function (params) {

                    console.log(params);

                    if(params.nodes.length > 0) {

                        $("#dropdown").css({ 'display': 'inline-block', 'top': event.clientY + "px", 'left': event.clientX + "px" });

                    } else {

                        $("#dropdown").css({ 'display': 'none' });
                    }

                });

                setInterval(function() {

                    sendRequest("get_node_state", "a-b-c");

                }.bind(this), 1000);
            };


        </script>

    </head>

    <body>
        
        <!-- Dropdown from W3 schools -->
        <div id="dropdown" class="dropdown">
            <a onclick="ctxMenuClick('create_job')" class="dropdownItem" >Create Job</a>
            <a onclick="ctxMenuClick('test_state')" class="dropdownItem" >Get Job Result</a>
        </div>

        <div id="mynetwork"></div>

        <button onclick='sendRequest("get_active_nodes", "a-b-c")'> Send Request </button>

    </body>


</html>